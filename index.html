import React, { useEffect, useMemo, useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { Table, TableBody, TableCaption, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Download, Plus, RefreshCw, Upload } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

// ------------------------- TYPES -------------------------
type Participant = {
  id: string;
  name: string;
};

type Expense = {
  id: string;
  description: string;
  amount: number; // importe base (sin propina)
  payerMode: "single" | "multi";
  payerId?: string; // si single
  payerSplits?: { payerId: string; amount: number }[]; // si multi (suma = amount)
  tipAmount?: number; // propina opcional
  tipPayerId?: string; // qui√©n puso la propina (puede ser distinto del pagador principal)
  participantIds: string[]; // quienes consumen (reparte amount + tip)
  date: string; // ISO date
  note?: string;
};

type EventData = {
  id: string; // slug
  name: string;
  currency: string;
  participants: Participant[];
  expenses: Expense[];
  createdAt: string;
};

// ------------------------- UTILS -------------------------
const currencies = ["EUR", "USD", "GBP", "MXN", "COP", "ARS", "CLP", "PEN"] as const;

type Currency = (typeof currencies)[number];

function slugify(s: string) {
  return s
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function fmt(amount: number, currency: string) {
  try {
    return new Intl.NumberFormat(undefined, { style: "currency", currency }).format(
      amount
    );
  } catch {
    return `${amount.toFixed(2)} ${currency}`;
  }
}

function uid(prefix = "id") {
  return `${prefix}_${Math.random().toString(36).slice(2, 10)}`;
}

function todayISO() {
  return new Date().toISOString().slice(0, 10);
}

function computeBalances(event: EventData) {
  const map: Record<string, number> = {};
  event.participants.forEach((p) => (map[p.id] = 0));

  for (const e of event.expenses) {
    const involved =
      e.participantIds.length > 0
        ? e.participantIds
        : event.participants.map((p) => p.id);

    const total = (e.amount || 0) + (e.tipAmount || 0);
    const share = total / involved.length;

    // Cr√©ditos a quien paga el importe base
    if (e.payerMode === "multi" && e.payerSplits?.length) {
      for (const s of e.payerSplits) {
        map[s.payerId] = (map[s.payerId] || 0) + s.amount;
      }
    } else if (e.payerId) {
      map[e.payerId] = (map[e.payerId] || 0) + (e.amount || 0);
    }

    // Cr√©dito de la propina (si existe) a quien la puso
    if (e.tipAmount && e.tipAmount > 0 && e.tipPayerId) {
      map[e.tipPayerId] = (map[e.tipPayerId] || 0) + e.tipAmount;
    }

    // D√©bitos a quienes consumen (importe + propina proporcional)
    for (const pid of involved) {
      map[pid] = (map[pid] || 0) - share;
    }
  }

  for (const k in map) {
    map[k] = Math.round(map[k] * 100) / 100;
  }
  return map; // positivo -> debe recibir; negativo -> debe pagar
}

function settleDebts(balances: Record<string, number>) {
  const debtors: { id: string; amount: number }[] = [];
  const creditors: { id: string; amount: number }[] = [];
  Object.entries(balances).forEach(([id, amt]) => {
    if (amt < -0.009) debtors.push({ id, amount: -amt });
    else if (amt > 0.009) creditors.push({ id, amount: amt });
  });
  debtors.sort((a, b) => b.amount - a.amount);
  creditors.sort((a, b) => b.amount - a.amount);
  const txs: { from: string; to: string; amount: number }[] = [];
  let i = 0,
    j = 0;
  while (i < debtors.length && j < creditors.length) {
    const d = debtors[i];
    const c = creditors[j];
    const pay = Math.min(d.amount, c.amount);
    txs.push({ from: d.id, to: c.id, amount: Math.round(pay * 100) / 100 });
    d.amount -= pay;
    c.amount -= pay;
    if (d.amount <= 0.009) i++;
    if (c.amount <= 0.009) j++;
  }
  return txs;
}

function download(filename: string, content: string, mime = "application/json") {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([content], { type: mime }));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// ------------------------- MAIN APP -------------------------
export default function App() {
  const [step, setStep] = useState<"setup" | "participants" | "event">("setup");
  const [eventName, setEventName] = useState("");
  const [currency, setCurrency] = useState<Currency>("EUR");
  const [numParticipants, setNumParticipants] = useState(2);
  const [participantsDraft, setParticipantsDraft] = useState<string[]>([]);
  const [event, setEvent] = useState<EventData | null>(null);
  const [openExpense, setOpenExpense] = useState(false);

  // load from localStorage by last used event
  useEffect(() => {
    const lastKey = localStorage.getItem("partipay:last");
    if (lastKey) {
      const raw = localStorage.getItem(lastKey);
      if (raw) {
        try {
          const parsed: EventData = JSON.parse(raw);
          setEvent(parsed);
          setStep("event");
          setEventName(parsed.name);
          setCurrency((parsed.currency as Currency) || "EUR");
        } catch {}
      }
    }
  }, []);

  // persist event
  useEffect(() => {
    if (event) {
      const key = `partipay:${event.id}`;
      localStorage.setItem(key, JSON.stringify(event));
      localStorage.setItem("partipay:last", key);
    }
  }, [event]);

  const balances = useMemo(() => (event ? computeBalances(event) : {}), [event]);
  const settlements = useMemo(
    () => (event ? settleDebts(balances) : []),
    [event, balances]
  );

  // ----------------------- SETUP -----------------------
  const handleSetupNext = () => {
    const n = Math.max(1, Math.min(20, numParticipants));
    setParticipantsDraft(Array.from({ length: n }, (_, i) => `P${i + 1}`));
    setStep("participants");
  };

  const handleCreateEvent = () => {
    const cleanNames = participantsDraft.map((s) => s.trim()).filter(Boolean);
    if (!eventName.trim()) return alert("Ponle nombre al evento ‚úçÔ∏è");
    if (cleanNames.length < 1) return alert("Necesitas al menos 1 participante");
    const parts: Participant[] = cleanNames.map((name, idx) => ({
      id: uid(`p${idx + 1}`),
      name,
    }));
    const id = slugify(eventName) || `evento-${Date.now()}`;
    const ev: EventData = {
      id,
      name: eventName.trim(),
      currency,
      participants: parts,
      expenses: [],
      createdAt: new Date().toISOString(),
    };
    setEvent(ev);
    setStep("event");
  };

  const resetAll = () => {
    if (!event) return;
    if (confirm("¬øSeguro que quieres borrar todos los gastos?")) {
      setEvent({ ...event, expenses: [] });
    }
  };

  const exportJSON = () => {
    if (!event) return;
    download(`${event.id}.json`, JSON.stringify(event, null, 2));
  };

  const exportCSV = () => {
  if (!event) return;
  const rows = [
    [
      "date",
      "description",
      "payerMode",
      "payer",
      "payerSplits",
      "amount",
      "tipAmount",
      "tipPayer",
      "participants",
    ],
    ...event.expenses.map((e) => {
      const payerName = e.payerId
        ? (event.participants.find((p) => p.id === e.payerId)?.name || "")
        : "";
      const splits = (e.payerSplits || [])
        .map((s) => {
          const n = event.participants.find((p) => p.id === s.payerId)?.name || "";
          return n + ":" + s.amount.toFixed(2);
        })
        .join("|");
      const tipPayer = e.tipPayerId
        ? (event.participants.find((p) => p.id === e.tipPayerId)?.name || "")
        : "";
      const participantsNames = e.participantIds
        .map((pid) => event.participants.find((p) => p.id === pid)?.name)
        .join("|");
      // Escapar comillas dobles para CSV correctamente: " -> ""
      const desc = e.description || "";
      const safeDesc = '"' + desc.replace(/"/g, '""') + '"';
      return [
        e.date,
        safeDesc,
        e.payerMode,
        payerName,
        splits,
        e.amount.toFixed(2),
        (e.tipAmount || 0).toFixed(2),
        tipPayer,
        participantsNames,
      ];
    }),
  ];
  const csv = rows.map((r) => r.join(",")).join("
");
  download(event.id + ".csv", csv, "text/csv");
};

  const importJSON = (file: File) => {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(String(reader.result));
        if (!data || !data.participants || !data.expenses)
          throw new Error("Formato no v√°lido");
        setEvent(data);
        setStep("event");
        setEventName(data.name || "");
        setCurrency((data.currency as Currency) || "EUR");
      } catch (err: any) {
        alert("No se pudo importar: " + err?.message);
      }
    };
    reader.readAsText(file);
  };

  // ----------------------- RENDER -----------------------
  return (
    <div className="min-h-screen bg-neutral-50 p-4 md:p-8">
      <div className="mx-auto max-w-5xl">
        <motion.h1
          initial={{ opacity: 0, y: -10 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-3xl md:text-4xl font-bold tracking-tight"
        >
          PartiPay
          <span className="text-neutral-500 font-light"> / comparte gastos sin dramas</span>
        </motion.h1>
        <p className="text-neutral-600 mt-1 mb-6">
          Crea un evento, a√±ade participantes y deja que las mates hagan magia. Nada de
          "yo te invit√© al caf√©"‚Ä¶ bueno, salvo que el caf√© sea espectacular ‚òïÔ∏è.
        </p>

        {step !== "event" && (
          <div className="grid md:grid-cols-2 gap-6">
            <Card className="rounded-2xl shadow-sm">
              <CardHeader>
                <CardTitle>1) Crea tu Evento</CardTitle>
                <CardDescription>
                  Nombre y moneda. F√°cil, como repartir croquetas.
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label>Nombre del evento</Label>
                  <Input
                    placeholder="P. ej., Fin de semana en Trives"
                    value={eventName}
                    onChange={(e) => setEventName(e.target.value)}
                  />
                </div>
                <div className="space-y-2">
                  <Label>Moneda</Label>
                  <Select value={currency} onValueChange={(v) => setCurrency(v as Currency)}>
                    <SelectTrigger>
                      <SelectValue placeholder="Selecciona moneda" />
                    </SelectTrigger>
                    <SelectContent>
                      {currencies.map((c) => (
                        <SelectItem key={c} value={c}>
                          {c}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </CardContent>
            </Card>

            {step === "setup" && (
              <Card className="rounded-2xl shadow-sm">
                <CardHeader>
                  <CardTitle>2) ¬øCu√°ntos participantes?</CardTitle>
                  <CardDescription>Prometo no juzgar si sois 2‚Ä¶ o 20.</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="space-y-2">
                    <Label>N√∫mero de participantes</Label>
                    <Input
                      type="number"
                      min={1}
                      max={20}
                      value={numParticipants}
                      onChange={(e) =>
                        setNumParticipants(parseInt(e.target.value || "1"))
                      }
                    />
                  </div>
                  <Button onClick={handleSetupNext} className="w-full">
                    Continuar
                  </Button>
                </CardContent>
              </Card>
            )}

            {step === "participants" && (
              <Card className="rounded-2xl shadow-sm md:col-span-2">
                <CardHeader>
                  <CardTitle>2) Nombres de participantes</CardTitle>
                  <CardDescription>
                    Pon nombres reales o alias √©picos. Kai cuenta si paga con ronroneos.
                  </CardDescription>
                </CardHeader>
                <CardContent className="grid md:grid-cols-2 gap-4">
                  {participantsDraft.map((name, idx) => (
                    <div className="space-y-2" key={idx}>
                      <Label>Participante #{idx + 1}</Label>
                      <Input
                        value={name}
                        onChange={(e) =>
                          setParticipantsDraft((prev) =>
                            prev.map((v, i) => (i === idx ? e.target.value : v))
                          )
                        }
                      />
                    </div>
                  ))}
                  <div className="md:col-span-2 flex gap-2 justify-end">
                    <Button variant="secondary" onClick={() => setStep("setup")}>Volver</Button>
                    <Button onClick={handleCreateEvent}>Crear Evento</Button>
                  </div>
                </CardContent>
              </Card>
            )}
          </div>
        )}

        {step === "event" && event && (
          <AnimatePresence>
            <motion.div
              initial={{ opacity: 0, y: 10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0 }}
              className="space-y-6"
            >
              <Card className="rounded-2xl">
                <CardHeader className="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                  <div>
                    <CardTitle className="flex items-center gap-2">
                      Evento: <span className="font-semibold">{event.name}</span>
                    </CardTitle>
                    <CardDescription>
                      Moneda: {event.currency} ‚Ä¢ Participantes: {event.participants.length} ‚Ä¢ Gastos: {event.expenses.length}
                    </CardDescription>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    <AddExpenseDialog
                      event={event}
                      setEvent={setEvent}
                      open={openExpense}
                      setOpen={setOpenExpense}
                    />
                    <Button variant="outline" onClick={exportCSV} title="Exportar CSV">
                      <Download className="h-4 w-4 mr-2" />CSV
                    </Button>
                    <Button variant="outline" onClick={exportJSON} title="Exportar JSON">
                      <Download className="h-4 w-4 mr-2" />JSON
                    </Button>
                    <label className="inline-flex items-center gap-2 px-3 py-2 rounded-md border text-sm cursor-pointer hover:bg-neutral-50">
                      <Upload className="h-4 w-4" />
                      Importar
                      <input
                        type="file"
                        accept="application/json"
                        className="hidden"
                        onChange={(e) => {
                          const f = e.target.files?.[0];
                          if (f) importJSON(f);
                        }}
                      />
                    </label>
                    <Button variant="destructive" onClick={resetAll} title="Borrar todos los gastos">
                      <RefreshCw className="h-4 w-4 mr-2" />Reset
                    </Button>
                  </div>
                </CardHeader>
              </Card>

              <div className="grid md:grid-cols-2 gap-6">
                <Card className="rounded-2xl">
                  <CardHeader>
                    <CardTitle>Balances</CardTitle>
                    <CardDescription>
                      Positivo = te deben. Negativo = debes.
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Participante</TableHead>
                          <TableHead className="text-right">Balance</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {event.participants.map((p) => (
                          <TableRow key={p.id}>
                            <TableCell>{p.name}</TableCell>
                            <TableCell
                              className={`text-right ${
                                (balances[p.id] || 0) >= 0
                                  ? "text-emerald-700"
                                  : "text-rose-700"
                              }`}
                            >
                              {fmt(balances[p.id] || 0, event.currency)}
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </CardContent>
                </Card>

                <Card className="rounded-2xl">
                  <CardHeader>
                    <CardTitle>Liquidaciones sugeridas</CardTitle>
                    <CardDescription>
                      Para cerrar el chiringuito con el m√≠nimo de pagos.
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    {settlements.length === 0 ? (
                      <p className="text-sm text-neutral-600">
                        Todo en paz. Nadie le debe nada a nadie. Milagro contable ‚ú®
                      </p>
                    ) : (
                      <ul className="space-y-2">
                        {settlements.map((t, idx) => {
                          const from = event.participants.find((p) => p.id === t.from)?.name;
                          const to = event.participants.find((p) => p.id === t.to)?.name;
                          return (
                            <li key={idx} className="text-sm">
                              <span className="font-medium">{from}</span> ‚Üí {" "}
                              <span className="font-medium">{to}</span>: {fmt(t.amount, event.currency)}
                            </li>
                          );
                        })}
                      </ul>
                    )}
                  </CardContent>
                </Card>
              </div>

              <Card className="rounded-2xl">
                <CardHeader>
                  <CardTitle>Gastos</CardTitle>
                  <CardDescription>Registra qui√©n pag√≥ qu√© y para qui√©n.</CardDescription>
                </CardHeader>
                <CardContent>
                  {event.expenses.length === 0 ? (
                    <div className="text-sm text-neutral-600">
                      A√∫n no hay gastos. ¬°Estrena el bot√≥n "A√±adir gasto"! üí∏
                    </div>
                  ) : (
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Fecha</TableHead>
                          <TableHead>Descripci√≥n</TableHead>
                          <TableHead>Pagadores</TableHead>
                          <TableHead className="text-right">Importe</TableHead>
                          <TableHead>Propina</TableHead>
                          <TableHead>Para</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {event.expenses.map((e) => {
                          const payerLabel =
                            e.payerMode === "single"
                              ? event.participants.find((p) => p.id === e.payerId)?.name
                              : (e.payerSplits || [])
                                  .map(
                                    (s) =>
                                      `${event.participants.find((p) => p.id === s.payerId)?.name} (${fmt(
                                        s.amount,
                                        event.currency
                                      )})`
                                  )
                                  .join(", ");
                          const tipLabel = e.tipAmount
                            ? `${fmt(e.tipAmount, event.currency)} ‚Äî ${
                                event.participants.find((p) => p.id === e.tipPayerId)?.name
                              }`
                            : "-";
                          const names = e.participantIds
                            .map((pid) => event.participants.find((p) => p.id === pid)?.name)
                            .join(", ");
                          return (
                            <TableRow key={e.id}>
                              <TableCell className="whitespace-nowrap">{e.date}</TableCell>
                              <TableCell className="max-w-[24ch] truncate" title={e.description}>
                                {e.description}
                              </TableCell>
                              <TableCell>{payerLabel}</TableCell>
                              <TableCell className="text-right">{fmt(e.amount, event.currency)}</TableCell>
                              <TableCell>{tipLabel}</TableCell>
                              <TableCell className="max-w-[24ch] truncate" title={names}>
                                {names}
                              </TableCell>
                            </TableRow>
                          );
                        })}
                      </TableBody>
                      <TableCaption className="text-xs text-neutral-500">
                        Consejo: exporta a CSV/JSON para compartir con el grupo.
                      </TableCaption>
                    </Table>
                  )}
                </CardContent>
              </Card>
            </motion.div>
          </AnimatePresence>
        )}
      </div>
    </div>
  );
}

// ----------------------- ADD EXPENSE DIALOG -----------------------
function AddExpenseDialog({
  event,
  setEvent,
  open,
  setOpen,
}: {
  event: EventData;
  setEvent: (ev: EventData) => void;
  open: boolean;
  setOpen: (v: boolean) => void;
}) {
  const [amount, setAmount] = useState<string>("");
  const [tip, setTip] = useState<string>("");
  const [desc, setDesc] = useState("");
  const [date, setDate] = useState(todayISO());
  const [payerMode, setPayerMode] = useState<"single" | "multi">("single");
  const [payerId, setPayerId] = useState(event.participants[0]?.id || "");
  const [tipPayerId, setTipPayerId] = useState(event.participants[0]?.id || "");
  const [payerSplits, setPayerSplits] = useState<{ payerId: string; amount: string }[]>([]);
  const [selected, setSelected] = useState<string[]>(event.participants.map((p) => p.id));
  const [note, setNote] = useState("");

  useEffect(() => {
    setSelected(event.participants.map((p) => p.id));
    setPayerId(event.participants[0]?.id || "");
    setTipPayerId(event.participants[0]?.id || "");
    setDate(todayISO());
    setAmount("");
    setDesc("");
    setNote("");
    setTip("");
    setPayerMode("single");
    setPayerSplits([]);
  }, [open, event.participants]);

  const toggleSelectAll = (all: boolean) => {
    setSelected(all ? event.participants.map((p) => p.id) : []);
  };

  const toggleParticipant = (pid: string) => {
    setSelected((prev) =>
      prev.includes(pid) ? prev.filter((x) => x !== pid) : [...prev, pid]
    );
  };

  const addSplitRow = () => {
    setPayerSplits((prev) => [
      ...prev,
      { payerId: event.participants[0]?.id || "", amount: "" },
    ]);
  };

  const removeSplitRow = (idx: number) => {
    setPayerSplits((prev) => prev.filter((_, i) => i !== idx));
  };

  const submit = () => {
    const base = parseFloat(amount.replace(",", "."));
    const tipVal = parseFloat((tip || "0").replace(",", ".")) || 0;
    if (!(base > 0)) return alert("Pon un importe mayor que 0");
    if (!desc.trim()) return alert("Describe el gasto (ej.: Caf√© de especialidad)");
    if (selected.length === 0) return alert("Selecciona al menos 1 participante");

    let payerModeValue: "single" | "multi" = payerMode;
    let payerIdValue: string | undefined = undefined;
    let payerSplitsValue: { payerId: string; amount: number }[] | undefined = undefined;

    if (payerMode === "single") {
      payerIdValue = payerId;
    } else {
      const parsedSplits = payerSplits.map((r) => ({
        payerId: r.payerId,
        amount: parseFloat((r.amount || "0").replace(",", ".")) || 0,
      }));
      const sum = parsedSplits.reduce((a, b) => a + b.amount, 0);
      if (Math.abs(sum - base) > 0.01) {
        return alert(
          `Las aportaciones de pagadores (${sum.toFixed(2)}) deben sumar el importe base (${base.toFixed(2)}).`
        );
      }
      if (parsedSplits.some((s) => !s.payerId || s.amount <= 0)) {
        return alert(
          "Revisa las filas de pagadores: importes > 0 y pagador seleccionado."
        );
      }
      payerSplitsValue = parsedSplits;
    }

    const expense: Expense = {
      id: uid("e"),
      description: desc.trim(),
      amount: Math.round(base * 100) / 100,
      payerMode: payerModeValue,
      payerId: payerIdValue,
      payerSplits: payerSplitsValue,
      tipAmount: Math.round(tipVal * 100) / 100 || undefined,
      tipPayerId: tipVal > 0 ? tipPayerId : undefined,
      participantIds: [...selected],
      date,
      note: note.trim() || undefined,
    };
    setEvent({ ...event, expenses: [...event.expenses, expense] });
    setOpen(false);
  };

  const base = parseFloat((amount || "0").replace(",", ".")) || 0;
  const tipVal = parseFloat((tip || "0").replace(",", ".")) || 0;
  const total = base + tipVal;
  const involvedCount = Math.max(1, selected.length);
  const perHead = total / involvedCount;

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button>
          <Plus className="h-4 w-4 mr-2" />A√±adir gasto
        </Button>
      </DialogTrigger>
      <DialogContent className="sm:max-w-[720px]">
        <DialogHeader>
          <DialogTitle>Nuevo gasto</DialogTitle>
        </DialogHeader>
        <div className="grid md:grid-cols-2 gap-4 py-2">
          <div className="space-y-2">
            <Label>Importe ({event.currency})</Label>
            <Input
              inputMode="decimal"
              placeholder="0,00"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
            />
          </div>
          <div className="space-y-2">
            <Label>Propina ({event.currency})</Label>
            <Input
              inputMode="decimal"
              placeholder="0,00"
              value={tip}
              onChange={(e) => setTip(e.target.value)}
            />
          </div>
          <div className="space-y-2">
            <Label>Fecha</Label>
            <Input type="date" value={date} onChange={(e) => setDate(e.target.value)} />
          </div>
          <div className="space-y-2 md:col-span-1">
            <Label>Descripci√≥n</Label>
            <Input
              placeholder="Cena, peajes, caf√©s, entradas‚Ä¶"
              value={desc}
              onChange={(e) => setDesc(e.target.value)}
            />
          </div>

          <div className="md:col-span-2 space-y-2">
            <Label>¬øQui√©n paga el importe base?</Label>
            <div className="flex gap-3 text-sm">
              <label className="inline-flex items-center gap-2">
                <input
                  type="radio"
                  className="accent-black"
                  checked={payerMode === "single"}
                  onChange={() => setPayerMode("single")}
                />
                <span>Una persona</span>
              </label>
              <label className="inline-flex items-center gap-2">
                <input
                  type="radio"
                  className="accent-black"
                  checked={payerMode === "multi"}
                  onChange={() => setPayerMode("multi")}
                />
                <span>Varios (repartido)</span>
              </label>
            </div>

            {payerMode === "single" ? (
              <div className="space-y-2">
                <Label>Pag√≥</Label>
                <Select value={payerId} onValueChange={setPayerId}>
                  <SelectTrigger>
                    <SelectValue placeholder="Qui√©n puso la pasta" />
                  </SelectTrigger>
                  <SelectContent>
                    {event.participants.map((p) => (
                      <SelectItem key={p.id} value={p.id}>
                        {p.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            ) : (
              <div className="space-y-2">
                <div className="flex items-center justify-between">
                  <Label>
                    Pagadores y aportes (deben sumar {fmt(base, event.currency)})
                  </Label>
                  <Button variant="outline" size="sm" onClick={addSplitRow}>
                    A√±adir pagador
                  </Button>
                </div>
                <div className="space-y-2">
                  {payerSplits.length === 0 && (
                    <p className="text-xs text-neutral-500">
                      A√±ade filas con cada persona que puso dinero para este gasto.
                    </p>
                  )}
                  {payerSplits.map((row, idx) => (
                    <div key={idx} className="grid grid-cols-12 gap-2 items-center">
                      <div className="col-span-6">
                        <Select
                          value={row.payerId}
                          onValueChange={(v) =>
                            setPayerSplits((prev) =>
                              prev.map((r, i) => (i === idx ? { ...r, payerId: v } : r))
                            )
                          }
                        >
                          <SelectTrigger>
                            <SelectValue placeholder="Pagador" />
                          </SelectTrigger>
                          <SelectContent>
                            {event.participants.map((p) => (
                              <SelectItem key={p.id} value={p.id}>
                                {p.name}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>
                      <div className="col-span-5">
                        <Input
                          inputMode="decimal"
                          placeholder="0,00"
                          value={row.amount}
                          onChange={(e) =>
                            setPayerSplits((prev) =>
                              prev.map((r, i) => (i === idx ? { ...r, amount: e.target.value } : r))
                            )
                          }
                        />
                      </div>
                      <div className="col-span-1 text-right">
                        <Button
                          variant="destructive"
                          size="icon"
                          onClick={() => removeSplitRow(idx)}
                        >
                          √ó
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
                <p
                  className={`text-xs ${
                    Math.abs(
                      payerSplits.reduce(
                        (a, b) => a + (parseFloat(b.amount.replace(",", ".") || "0") || 0),
                        0
                      ) - base
                    ) < 0.01
                      ? "text-emerald-600"
                      : "text-rose-600"
                  }`}
                >
                  Suma actual: {fmt(
                    payerSplits.reduce(
                      (a, b) => a + (parseFloat(b.amount.replace(",", ".") || "0") || 0),
                      0
                    ),
                    event.currency
                  )}
                </p>
              </div>
            )}
          </div>

          <div className="space-y-2">
            <Label>¬øQui√©n paga la propina?</Label>
            <Select value={tipPayerId} onValueChange={setTipPayerId}>
              <SelectTrigger>
                <SelectValue placeholder="Selecciona pagador de la propina" />
              </SelectTrigger>
              <SelectContent>
                {event.participants.map((p) => (
                  <SelectItem key={p.id} value={p.id}>
                    {p.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label>Nota (opcional)</Label>
            <Textarea
              value={note}
              onChange={(e) => setNote(e.target.value)}
              placeholder="Detalles, c√≥digos de recibo‚Ä¶"
            />
          </div>

          <div className="md:col-span-2">
            <div className="flex items-center justify-between mb-2">
              <Label>
                Aplica a (qui√©n lo disfrut√≥) ‚Äî {involvedCount} personas ‚Üí {fmt(perHead || 0, event.currency)} / cabeza
              </Label>
              <div className="flex gap-2 text-xs">
                <Button variant="outline" size="sm" onClick={() => toggleSelectAll(true)}>
                  Todos
                </Button>
                <Button variant="outline" size="sm" onClick={() => toggleSelectAll(false)}>
                  Ninguno
                </Button>
                <Button variant="outline" size="sm" onClick={() => setSelected([payerId])}>
                  Solo pagador
                </Button>
              </div>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
              {event.participants.map((p) => (
                <label key={p.id} className="flex items-center gap-2 rounded-lg border p-2">
                  <Checkbox
                    checked={selected.includes(p.id)}
                    onCheckedChange={() => toggleParticipant(p.id)}
                  />
                  <span>{p.name}</span>
                </label>
              ))}
            </div>
          </div>
        </div>
        <DialogFooter>
          <Button variant="secondary" onClick={() => setOpen(false)}>
            Cancelar
          </Button>
          <Button onClick={submit}>Guardar</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
